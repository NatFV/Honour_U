<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title th:text="${proyecto.nombreProyecto} + ' – Panel'">Panel</title>
    <th:block layout:fragment="extra_head">
        <style>
            .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
            .card-page { border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.05); }
            .thumb { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; background: #fafafa; }
            .handle { cursor: grab; }
            .pill { font-size: 12px; padding: 2px 6px; border-radius: 999px; }
            .pill-green { background: #e8f5e9; color: #2e7d32; }
            .pill-gray { background: #eceff1; color: #455a64; }
            .drag-ghost { opacity: .6; }
        </style>
    </th:block>
</head>
<body>
<section layout:fragment="content">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0" th:text="${proyecto.nombreProyecto}">Proyecto</h2>
        <div class="text-muted small">Token público: <code th:text="${proyecto.tokenUrl}"></code></div>
    </div>

    <p class="mb-3">Arrastra para reordenar las páginas y pulsa “Guardar orden”.</p>

    <div class="d-flex flex-wrap gap-2 mb-3">
        <!-- Botón Portada: abre modal -->
        <a class="btn btn-outline-primary"
           th:href="@{/proyectos/admin/{t}/portada(t=${proyecto.adminToken})}">
            Configurar Portada
        </a>

        <!-- Crear/actualizar Índice -->
        <form th:action="@{/proyectos/admin/{adminToken}/indice(adminToken=${proyecto.adminToken})}" method="post" class="d-inline">
            <button type="submit" class="btn btn-outline-secondary">Crear/Actualizar Índice</button>
        </form>

        <!-- Añadir página vacía -->
        <form th:action="@{/proyectos/admin/{adminToken}/addBlank(adminToken=${proyecto.adminToken})}" method="post" class="d-inline">
            <button type="submit" class="btn btn-success">Añadir página vacía</button>
        </form>
    </div>

    <!-- Modal Portada -->
    <div class="modal fade" id="modalPortada" tabindex="-1" aria-labelledby="modalPortadaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form class="modal-content" th:action="@{/proyectos/admin/{adminToken}/portada(adminToken=${proyecto.adminToken})}" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPortadaLabel">Configurar Portada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Título del homenaje</label>
                        <input type="text" name="titulo" class="form-control" placeholder="Ej. 'Homenaje a María García'"
                               th:value="${#lists.isEmpty(aportaciones) ? '' : ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Imagen de portada (opcional)</label>
                        <input type="file" name="imagen" class="form-control" accept="image/*">
                        <div class="form-text">Si subes una imagen, reemplazará la anterior.</div>
                    </div>
                    <!-- Vista previa simple (si quieres mostrar la actual) -->
                    <div class="mt-2" th:if="${aportaciones != null}">
                        <small class="text-muted">Portada actual:</small>
                        <div th:each="a : ${aportaciones}" th:if="${a.pageType.name() == 'PORTADA'}">
                            <img th:if="${a.mediaUrls != null and a.mediaUrls.size() > 0}" th:src="@{${a.mediaUrls[0]}}" alt="" style="max-width:100%; border-radius:6px;">
                            <div class="text-muted" th:text="${a.mensaje}" style="margin-top:6px;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="submit">Guardar Portada</button>
                </div>
            </form>
        </div>
    </div>




    <div id="grid" class="grid" th:with="token=${proyecto.tokenUrl}">
        <div class="card-page handle" th:each="a : ${aportaciones}" th:id="'item-'+${a.aportacionId}">
            <div class="mb-2 d-flex justify-content-between align-items-center">
                <div class="fw-semibold" th:text="${a.remitente} ?: 'Anónimo'">Anónimo</div>
                <span class="pill pill-gray ms-2" th:text="${a.pageType.name()}">NORMAL</span>
                <span class="pill" th:classappend="${a.esVisible} ? ' pill-green' : ' pill-gray'"
                      th:text="${a.esVisible} ? 'Visible' : 'No visible'">Visible</span>
            </div>

            <!-- miniatura: PRIMER MEDIA si existe (sin #lists.first) -->
            <div class="mb-2">
                <img class="thumb"
                     th:if="${a.mediaUrls != null and a.mediaUrls.size() > 0}"
                     th:src="@{${a.mediaUrls[0]}}" alt="">
                <div class="thumb d-flex align-items-center justify-content-center text-muted"
                     th:if="${a.mediaUrls == null or a.mediaUrls.size() == 0}">Sin media</div>
            </div>

            <!-- ACCIONES SI ES PORTADA -->
            <div class="d-flex gap-2"
                 th:if="${a.pageType.name() == 'PORTADA'}">

                <!-- Editar (abre el formulario de portada) -->
                <a class="btn btn-sm btn-primary"
                   th:href="@{/proyectos/admin/{t}/portada(t=${proyecto.adminToken})}">
                    Editar portada
                </a>

                <!-- Eliminar (borra BD + /uploads/{token}/portada) -->
                <form th:action="@{/proyectos/admin/{t}/portada/eliminar(t=${proyecto.adminToken})}"
                      method="post"
                      onsubmit="return confirm('¿Eliminar la portada? Se borrarán también sus imágenes.');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
                </form>
            </div>

            <!-- ACCIONES PARA EL RESTO (NORMAL/INDICE...) -->
            <div class="d-flex gap-2"
                 th:if="${a.pageType.name() != 'PORTADA'}">
                <a class="btn btn-sm btn-outline-secondary"
                   th:href="@{/proyectos/token/{token}/aportaciones/{id}/ver(token=${token}, id=${a.aportacionId})}"
                   target="_blank">Ver</a>

                <button class="btn btn-sm btn-outline-primary btn-toggle"
                        th:attr="data-id=${a.aportacionId}">
                    <span th:text="${a.esVisible} ? 'Ocultar' : 'Mostrar'">Ocultar</span>
                </button>
            </div>

        </div>
    </div>

    <div class="mt-3">
        <button id="btnGuardar" class="btn btn-success">Guardar orden</button>
    </div>

    <a th:href="@{/proyectos/admin/{t}/export.pdf(t=${proyecto.adminToken})}"
       class="btn btn-outline-secondary ms-2" target="_blank">
        Descargar PDF
    </a>

</section>

<th:block layout:fragment="scripts">
    <!-- SortableJS (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('grid');
            const adminToken = /*[[${proyecto.adminToken}]]*/ '';
            const ordenURL = `/proyectos/admin/${adminToken}/orden`;
            const toggleURL = (id) => `/proyectos/admin/${adminToken}/aportaciones/${id}/toggleVisible`;

            const sortable = new Sortable(grid, {
                animation: 150,
                ghostClass: 'drag-ghost',
                handle: '.handle'
            });

            document.getElementById('btnGuardar').addEventListener('click', async () => {
                const ids = [...grid.children].map(el => Number(el.id.replace('item-','')));
                const res = await fetch(ordenURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ids)
                });
                if (res.ok) alert('Orden guardado'); else alert('No se pudo guardar el orden');
            });

            grid.addEventListener('click', async (e) => {
                const btn = e.target.closest('.btn-toggle');
                if (!btn) return;
                const id = btn.getAttribute('data-id');
                const res = await fetch(toggleURL(id), { method: 'POST' });
                if (res.ok) {
                    const data = await res.json();
                    const card = btn.closest('.card-page');
                    const pill = card.querySelector('.pill');
                    if (data.visible) {
                        pill.classList.remove('pill-gray'); pill.classList.add('pill-green');
                        pill.textContent = 'Visible'; btn.textContent = 'Ocultar';
                    } else {
                        pill.classList.remove('pill-green'); pill.classList.add('pill-gray');
                        pill.textContent = 'No visible'; btn.textContent = 'Mostrar';
                    }
                } else {
                    alert('No se pudo cambiar la visibilidad');
                }
            });
        });
    </script>
</th:block>
</body>
</html>
