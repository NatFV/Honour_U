<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title>Editar Aportación</title>
    <th:block layout:fragment="extra_head">
        <style>
            .pagina { width:100%; max-width:720px; min-height:800px; border:1px solid #e5e5e5; margin:20px auto; padding:40px 50px; box-shadow:0 4px 15px rgba(0,0,0,0.08); background:#fffef8; border-radius:10px; position:relative;  color: #111;   }
            .titulo-proyecto { text-align:center; font-weight:700; font-size:22px; margin-bottom:8px; }
            .editor-remitente { text-align:center; font-size:16px; color:#444; font-style:italic; min-height:24px; margin-bottom:15px; }
            .editor-mensaje { min-height:300px; border:1px dashed #ccc; border-radius:8px; padding:12px; font-size:15px; background:#fafafa; line-height:1.5; outline:none; white-space:pre-wrap; }
            .editor-mensaje[contenteditable]:empty:before,
            .editor-remitente[contenteditable]:empty:before { content: attr(data-placeholder); color:#bbb; }
            .media img, .media video, .media audio { max-width:100%; height:auto; margin-top:10px; border-radius:6px; }
            .preview-container { max-width:760px; margin:0 auto; }
             .zona-drop{
                 border:2px dashed #b5b5b5; border-radius:8px; padding:16px; text-align:center;
                 transition:background .2s, border-color .2s; margin-top:16px; min-height:120px;
             }
            .zona-drop.dragover{ background:#eef9ff; border-color:#66afe9; }
        </style>
    </th:block>
</head>
<body>
<section layout:fragment="content">
    <h2 class="mb-4 text-center">Editar Aportación</h2>

    <!-- Importante: action condicional por adminMode -->
    <form
            th:action="${adminMode} ?
            @{/proyectos/admin/{t}/aportaciones/{id}/editar(t=${proyecto.adminToken}, id=${aportacion.aportacionId})} :
            @{/proyectos/token/{token}/aportaciones/{id}/editar(token=${proyecto.tokenUrl}, id=${aportacion.aportacionId})}"
            th:object="${aportacion}"
            method="post"
            enctype="multipart/form-data"
            id="editarForm">

        <input type="hidden" th:field="*{mensaje}" id="mensajeHidden"/>
        <input type="hidden" th:field="*{remitente}" id="remitenteHidden"/>

        <div class="preview-container mx-auto">
            <div id="preview" class="pagina">
                <div class="titulo-proyecto" th:text="${proyecto.nombreProyecto} ?: 'Libro de Homenaje'"></div>

                <div id="editorRemitente" class="editor-remitente" contenteditable="true"
                     data-placeholder="Tu nombre..." th:text="*{remitente}">Remitente</div>

                <div id="editorMensaje" class="editor-mensaje" contenteditable="true"
                     data-placeholder="Escribe tu mensaje aquí..." th:text="*{mensaje}">Mensaje…</div>


                <div class="zona-drop" id="zonaDrop">
                    Arrastra aquí fotos
                    <div class="media" id="preview-nuevos">
                        <!-- Pongo las existentes aquí -->
                        <img th:each="u : ${aportacion.mediaUrls}" th:src="@{${u}}" alt="foto"
                             style="max-width:100%; border-radius:6px;">
                    </div>
                </div>

            </div>
        </div>


        <!-- Input oculto que usará el JS (opcional: lo puede crear el script si prefieres) -->
        <input type="file" name="imagenes" id="imagenesInput" multiple hidden
               accept="image/*,video/mp4,video/webm,video/ogg,audio/mpeg,audio/ogg,audio/wav">


        <div class="text-center mt-4">
            <div class="form-check d-inline-block me-3">
                <input type="checkbox" th:field="*{esVisible}" class="form-check-input" id="visibleCheck">
                <label class="form-check-label" for="visibleCheck">¿Visible?</label>
            </div>
            <button type="submit" class="btn btn-primary">Guardar cambios</button>

            <!-- Enlace Cancelar condicional por adminMode -->
            <a class="btn btn-outline-danger ms-2"
               th:href="${adminMode} ?
                    @{/proyectos/admin/{t}/panel(t=${proyecto.adminToken})} :
                    @{/proyectos/token/{token}/aportaciones(token=${proyecto.tokenUrl})}">
                Cancelar
            </a>
        </div>
    </form>
</section>

<th:block layout:fragment="scripts">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editorRemitente = document.getElementById('editorRemitente');
            const editorMensaje = document.getElementById('editorMensaje');
            const remitenteHidden = document.getElementById('remitenteHidden');
            const mensajeHidden = document.getElementById('mensajeHidden');

            const syncRemitente = () => remitenteHidden.value = editorRemitente.innerText.trim();
            const syncMensaje = () => mensajeHidden.value = editorMensaje.innerText.trim();

            editorRemitente.addEventListener('input', syncRemitente);
            editorMensaje.addEventListener('input', syncMensaje);

            // Sincroniza ahora por si el usuario envía sin tocar
            syncRemitente(); syncMensaje();

            document.getElementById('editarForm').addEventListener('submit', () => {
                syncRemitente(); syncMensaje();
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const zonaDrop = document.getElementById('zonaDrop');
            const previewNuevos = document.getElementById('preview-nuevos');
            const input = document.getElementById('imagenesInput')
                || (() => { const i=document.createElement('input'); i.type='file'; i.name='imagenes'; i.multiple=true; i.hidden=true; document.getElementById('editarForm').appendChild(i); return i; })();

            const renderFiles = (files) => {
                previewNuevos.innerHTML = '';
                [...files].forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        if (file.type.startsWith('image/')) {
                            const img = document.createElement('img');
                            img.src = e.target.result; img.style.maxWidth='100%'; img.style.borderRadius='6px';
                            previewNuevos.appendChild(img);
                        } else if (file.type.startsWith('video/')) {
                            const v = document.createElement('video');
                            v.src = e.target.result; v.controls = true; v.style.maxWidth='100%'; v.style.borderRadius='6px';
                            previewNuevos.appendChild(v);
                        } else if (file.type.startsWith('audio/')) {
                            const a = document.createElement('audio');
                            a.src = e.target.result; a.controls = true; a.style.width='100%';
                            previewNuevos.appendChild(a);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            };

            // Soporta arrastrar
            ['dragenter','dragover'].forEach(evt =>
                zonaDrop.addEventListener(evt, e => { e.preventDefault(); zonaDrop.classList.add('dragover'); })
            );
            ['dragleave','drop'].forEach(evt =>
                zonaDrop.addEventListener(evt, e => { e.preventDefault(); zonaDrop.classList.remove('dragover'); })
            );
            zonaDrop.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                renderFiles(files);
                const dt = new DataTransfer();
                for (const f of files) dt.items.add(f);
                input.files = dt.files; // listo para enviar en "imagenes"
            });

            // También clic para abrir selector de archivos
            zonaDrop.addEventListener('click', () => input.click());
            input.addEventListener('change', () => renderFiles(input.files));
        });
    </script>

</th:block>
</body>
</html>
