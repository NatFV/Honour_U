<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <title th:text="${proyecto.nombreProyecto} + ' – Panel'">Panel</title>

    <th:block layout:fragment="extra_head">
        <style>
            .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
            .card-page { border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,.05); }
            .card-text {
                font-size: 0.875rem;
                color: #6c757d;             /* gris */
                display: -webkit-box;        /* necesario para line-clamp */
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
                -webkit-line-clamp: 2;       /* 1 línea = 1, 2 líneas = 2 */
                line-height: 1.2em;
                max-height: 2.4em;           /* line-height * number of lines */
                margin-bottom: 20px;
            }
            .thumb { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; background: #fafafa; }
            .handle { cursor: grab; }
            .pill { font-size: 12px; padding: 2px 6px; border-radius: 999px; }
            .pill-green { background: #e8f5e9; color: #2e7d32; }
            .pill-gray  { background: #eceff1; color: #455a64; }
            .drag-ghost { opacity: .6; }
        </style>
    </th:block>
</head>
<body>
<section layout:fragment="content" style="color:black">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0" th:text="${proyecto.nombreProyecto}">Proyecto</h2>
    </div>

    <p class="mb-3">Arrastra para reordenar las páginas y pulsa “Guardar orden”.</p>

    <div class="d-flex flex-wrap gap-2 mb-3">
        <!-- Configurar Portada -->
        <a class="btn btn-primary"
           th:href="@{/proyectos/admin/{adminToken}/portada(adminToken=${proyecto.adminToken})}">
            Crear portada
        </a>

        <!-- Crear/actualizar Índice -->
        <form th:action="@{/proyectos/admin/{adminToken}/indice(adminToken=${proyecto.adminToken})}"
              method="post" class="d-inline">
            <button type="submit" class="btn btn-secondary">Crear/Actualizar Índice</button>
        </form>

        <!-- Añadir página vacía -->
        <form th:action="@{/proyectos/admin/{adminToken}/addBlank(adminToken=${proyecto.adminToken})}"
              method="post" class="d-inline">
            <button type="submit" class="btn btn-info">Añadir página vacía</button>
        </form>
    </div>

    <!-- GRID de tarjetas (ADMIN) -->
    <div id="grid-admin" class="grid" th:with="token=${proyecto.tokenUrl}">
        <div class="card-page handle"
             th:each="a : ${aportaciones}"
             th:id="'item-'+${a.aportacionId}">
            <div class="mb-2 d-flex justify-content-between align-items-center">
                <div class="fw-semibold text-truncate" th:text="${a.remitente} ?: 'Anónimo'">Anónimo</div>
                <div class="d-flex align-items-center gap-1">
                    <span class="pill pill-gray" th:text="${a.pageType.name()}">NORMAL</span>
                    <span class="pill" th:classappend="${a.esVisible} ? ' pill-green' : ' pill-gray'"
                          th:text="${a.esVisible} ? 'Visible' : 'No visible'">Visible</span>
                </div>
            </div>

            <!-- Miniatura: primera media si existe -->
            <div class="mb-2">
                <img class="thumb"
                     th:if="${a.mediaUrls != null and a.mediaUrls.size() > 0}"
                     th:src="@{${a.mediaUrls[0]}}" alt="">
                <div class="thumb d-flex align-items-center justify-content-center text-muted"
                     th:if="${a.mediaUrls == null or a.mediaUrls.size() == 0}">Sin media</div>
            </div>

            <!-- Remitente + Mensaje -->
            <div class="card-text mt-2 small"> <div>
            </div> <div th:text="${a.mensaje}">Mensaje…</div> </div>

            <div class="d-flex gap-2">
                <!-- Editar (ADMIN: sin ownerKey/visibilidad) -->
                <a class="btn btn-sm btn-outline-primary"
                   th:href="@{/proyectos/admin/{adminToken}/aportaciones/{id}/editar(adminToken=${proyecto.adminToken}, id=${a.aportacionId})}">
                    Editar
                </a>

                <!-- Eliminar (ADMIN) -->
                <form th:action="@{/proyectos/admin/{adminToken}/aportaciones/{id}/eliminar(adminToken=${proyecto.adminToken}, id=${a.aportacionId})}"
                      method="post" onsubmit="return confirm('¿Eliminar esta aportación?');" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>

    <div class="mt-3 d-flex gap-2 align-items-center">
        <button id="btnGuardarOrden" type="button" class="btn btn-success">Guardar orden</button>

        <a th:href="@{/proyectos/admin/{t}/libro/crear(t=${proyecto.adminToken})}"
           class="btn btn-success">
            Crear libro
        </a>
    </div>

</section>

<!-- ================== SCRIPTS SOLO DEL PANEL ================== -->
<th:block layout:fragment="scripts">
    <!-- Sortable solo aquí, no en la vista de usuario -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <script th:inline="javascript">
        (() => {
            // Elementos del panel (ids únicos para no chocar con otras vistas)
            const grid = document.getElementById('grid-admin');
            const btn  = document.getElementById('btnGuardarOrden');
            if (!grid || !btn) return;

            // URL de guardado con adminToken
            const ADMIN_TOKEN = /*[[${proyecto.adminToken}]]*/ "";
            const ORDEN_URL   = `/proyectos/admin/${ADMIN_TOKEN}/orden`;

            // Habilitar drag & drop
            new Sortable(grid, {
                animation: 150,
                ghostClass: 'drag-ghost',
                handle: '.handle'
            });

            // Guardar orden
            let saving = false;
            btn.addEventListener('click', async () => {
                if (saving) return;
                saving = true;

                try {
                    const ids = Array.from(grid.children)
                        .map(el => el.id)
                        .filter(Boolean)
                        .map(s => Number(s.replace('item-','')))
                        .filter(n => !Number.isNaN(n));

                    const res = await fetch(ORDEN_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ids)
                    });

                    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
                    alert('Orden guardado');
                } catch (e) {
                    console.error(e);
                    alert('No se pudo guardar el orden');
                } finally {
                    saving = false;
                }
            });
        })();
    </script>
</th:block>
</body>
</html>
