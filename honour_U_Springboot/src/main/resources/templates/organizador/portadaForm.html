<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>Portada del proyecto</title>

    <th:block layout:fragment="extra_head">
        <style>
            body { background-color: #f9fafb; }

            /* ---- Dropzone ---- */
            .drop-zone {
                border: 2px dashed #d7d7d7;
                border-radius: 10px;
                padding: 28px;
                text-align: center;
                background: #fffef5;
                transition: 0.2s;
                cursor: pointer;
                position: relative;
            }
            .drop-zone.dragover { background: #eef7ff; border-color: #65a3ff; }
            .dz-instructions { color: black; font-size: 0.95rem; }

            /* Las miniaturas AHORA van dentro de la drop-zone */
            .drop-zone .preview {
                display: flex; flex-wrap: wrap; gap: 10px;
                margin-top: 14px; justify-content: center;
            }
            .drop-zone .preview img {
                width: 110px; height: 110px; object-fit: cover;
                border-radius: 8px; border: 1px solid #e0e0e0;
                background: #fafafa;
            }

            .portada-container {
                max-width: 720px;
                margin: 0 auto;
            }

            .portada-card {
                border: 1px solid #e5e5e5;
                background: #fffef8;
                border-radius: 10px;
                padding: 40px 50px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
                transition: all 0.3s ease;
            }

            .portada-card:focus-within {
                box-shadow: 0 0 0 4px rgba(100, 180, 255, 0.2);
            }

            .subtitulo{
                color: white;
                font-size: 20px;
            }

            .form-label{
                color: black;
            }
        </style>
    </th:block>
</head>

<body>
<section layout:fragment="content" class="container py-4">

    <h2 class="mb-3">Portada del proyecto</h2>
    <p class="subtitulo">
        Configura un título grande y una o varias imágenes. Esta página se usa solo para el libro/PDF y el panel de administración.
    </p>

    <!-- Envoltorio del formulario (permite fullscreen del área de edición si quieres) -->
    <div id="fsTarget" class="fs-target">

        <!-- Formulario de edición -->
        <form th:action="@{/proyectos/admin/{t}/portada(t=${proyecto.adminToken})}"
              method="post" enctype="multipart/form-data"
              class="portada-card mb-3">

            <div class="mb-3">
                <label class="form-label">Título del homenaje</label>
                <input id="tituloInput" type="text" name="titulo" class="form-control form-control-lg"
                       placeholder="Ej. Homenaje a María García"
                       th:value="${portada != null ? portada.mensaje : ''}" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Fotos de portada</label>

                <!-- DROP-ZONE con preview dentro -->
                <div class="drop-zone" id="drop-zone">
                    <div class="dz-instructions">Arrastra tus fotos aquí o haz clic para seleccionarlas</div>
                    <input type="file" name="imagenes" id="file-input" accept="image/*" multiple hidden>
                    <div class="preview" id="preview">
                        <!-- Miniaturas de imágenes ya guardadas (si hay) -->
                        <img th:each="url : ${portada?.mediaUrls}" th:src="@{${url}}" alt="">
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-primary">Guardar portada</button>
                <a th:href="@{/proyectos/admin/{t}/panel(t=${proyecto.adminToken})}"
                   class="btn btn-secondary">Volver al panel</a>
            </div>
        </form>

        </div>

    </div>

    <!-- ================== Scripts ================== -->
    <!-- permite arrastrar y soltar archivos (Dropzone), subir imágenes, previsualizarlas y recuperlaras -->
    <!-- Habilitamos inline para inyectar URLs existentes -->
    <script th:inline="javascript">
        // URLs ya guardadas en BD para esta portada (si existen)
        const existingUrls = /*[[${portada != null ? portada.mediaUrls : null}]]*/ null || [];
    </script>

    <script>
        // ---------- Dropzone ----------
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const preview = document.getElementById('preview');

        // Hacer clic en la zona abre el file picker
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag & drop efectos
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            showPreviewFromFiles(fileInput.files);
        });

        fileInput.addEventListener('change', () => showPreviewFromFiles(fileInput.files));

        function showPreviewFromFiles(files) {
            preview.innerHTML = '';
            [...files].forEach(f => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(f);
                preview.appendChild(img);
            });
        }
    </script>

</section>
</body>
</html>
